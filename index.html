<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>薪寄件</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* --- Google/Gemini Inspired UI Refresh (Copied from previous final mobile version) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif; background-color: #e8eaed; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px 0; }
        .app-container { width: 417px; height: 900px; background-color: #ffffff; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06); border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .page-content { flex-grow: 1; overflow-y: auto; padding: 20px; background-color: #f8f9fa; }
        .page { display: none; height: 100%; }
        .page.active { display: block; }
        .form-section { background-color: #ffffff; padding: 18px; margin-bottom: 16px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative; }
        .form-section h3 { font-size: 18px; color: #202124; margin-bottom: 16px; padding-bottom: 8px; border-bottom: none; font-weight: 500; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-size: 13px; color: #5f6368; margin-bottom: 6px; font-weight: 500; }
        .form-group input[type="text"], .form-group input[type="tel"], .form-group input[type="number"], .form-group input[type="date"], .form-group select, .form-group textarea { width: 100%; padding: 12px 14px; border: 1px solid #dadce0; border-radius: 8px; font-size: 15px; background-color: #f8f9fa; color: #202124; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #1a73e8; box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2); }
        .form-group textarea { min-height: 70px; }
        .clickable-field { padding: 12px 14px; border: 1px solid #dadce0; border-radius: 8px; background-color: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 15px; min-height: 48px; }
        .clickable-field .placeholder { color: #70757a; }
        .clickable-field .value { color: #202124; }
        .clickable-field::after { content: 'chevron_right'; font-family: 'Material Icons', sans-serif; color: #5f6368; font-weight: normal; font-size: 22px; line-height: 1; }
        .address-selection-group { margin-bottom: 5px; }
        .address-book-btn-container { position: absolute; top: 15px; right: 15px; }
        .payment-method { padding: 12px 14px; border: 1px solid #dadce0; border-radius: 8px; background-color: #f1f3f4; color: #3c4043; font-size: 15px; }
        .send-package-bottom-bar { background-color: #ffffff; padding: 16px 20px; border-top: 1px solid #dadce0; margin-top: 10px; }
        .price-estimate { font-size: 15px; margin-bottom: 12px; color: #202124; }
        .price-estimate span { font-weight: 500; color: #d93025; font-size: 20px; }
        .terms-agreement { display: flex; align-items: center; font-size: 13px; margin-bottom: 18px; color: #5f6368; }
        .terms-agreement input[type="checkbox"] { margin-right: 10px; width: 18px; height: 18px; accent-color: #1a73e8; }
        .terms-agreement a { color: #1a73e8; text-decoration: none; }
        .terms-agreement a:hover { text-decoration: underline; }
        .btn { display: block; width: 100%; padding: 12px 20px; background-color: #1a73e8; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 500; text-align: center; cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn:hover { background-color: #185abc; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        .btn:active { background-color: #174ea6; }
        .btn:disabled { background-color: #e0e0e0; color: #a0a0a0; cursor: not-allowed; box-shadow: none; }
        .btn-submit { background-color: #34a853; }
        .btn-submit:hover { background-color: #2c8a4e; }
        .btn-submit:active { background-color: #257543; }
        .btn-small { padding: 6px 12px; font-size: 13px; background-color: #5f6368; color:white; border:none; border-radius:6px; cursor: pointer; transition: background-color 0.2s ease; }
        .btn-small:hover { background-color: #3c4043; }
        .btn-link { background: none; border: none; color: #1a73e8; cursor: pointer; padding: 0; font-size: 14px; font-weight: 500; }
        .btn-link:hover { text-decoration: underline; }
        .bottom-nav { display: flex; width: 100%; border-top: 1px solid #dadce0; background-color: #ffffff; padding: 4px 0; }
        .nav-item { flex: 1; padding: 8px 0; text-align: center; cursor: pointer; color: #5f6368; font-size: 12px; font-weight: 400; border-radius: 8px; margin: 0 4px; transition: background-color 0.2s ease, color 0.2s ease; }
        .nav-item .nav-icon { font-size: 22px; display: block; margin-bottom: 2px; font-family: 'Material Icons'; }
        .nav-item.active { color: #1a73e8; background-color: #e8f0fe; }
        .nav-item:not(.active):hover { background-color: #f1f3f4; }
        .message-list-item { background-color: #fff; padding: 16px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message-content { font-size: 15px; color: #202124; margin-bottom: 8px; line-height: 1.6; }
        .message-time { font-size: 12px; color: #5f6368; text-align: right; }
        .order-records-header { margin-bottom: 16px; }
        .order-records-header input[type="search"] { width: 100%; padding: 12px 14px; border: 1px solid #dadce0; border-radius: 8px; font-size: 14px; background-color: #f1f3f4; margin-bottom: 12px; }
        .order-records-header input[type="search"]:focus { background-color: #fff; border-color: #1a73e8; box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2); }
        .filter-tags { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .filter-tag { padding: 6px 12px; border: 1px solid #dadce0; border-radius: 16px; font-size: 13px; color: #5f6368; cursor: pointer; background-color: #fff; transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .filter-tag.active { background-color: #e8f0fe; color: #1a73e8; border-color: #1a73e8; font-weight: 500; }
        .order-card-list { display: flex; flex-direction: column; gap: 12px; }
        .order-card { background-color: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.07); cursor: pointer; transition: box-shadow 0.2s ease; }
        .order-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .order-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .order-card-id { font-size: 15px; font-weight: 500; color: #202124; }
        .order-card-status { font-size: 13px; padding: 3px 8px; border-radius: 4px; font-weight: 500; }
        .order-card-status.status-pending, .order-card-status.status-processing { background-color: #fef0e5; color: #f2994a; }
        .order-card-status.status-awaiting-pickup { background-color: #fffbe6; color: #faad14; } 
        .order-card-status.status-shipped { background-color: #e6f7ff; color: #1890ff; }
        .order-card-status.status-delivered, .order-card-status.status-paid { background-color: #e6fffb; color: #13c2c2; }
        .order-card-status.status-registered { background-color: #f6ffed; color: #52c41a; }
        .order-card-status.status-cancelled, .order-card-status.status-unpaid { background-color: #fff1f0; color: #f5222d; }
        .order-card-body .info-line { display: flex; justify-content: space-between; font-size: 14px; color: #5f6368; margin-bottom: 6px; }
        .order-card-body .info-line .label { font-weight: 500; color: #3c4043; }
        .order-card-body .info-line .value { text-align: right; color: #202124; }
        .order-card-footer { margin-top: 10px; text-align: right; font-size: 12px; color: #70757a; }
        .no-records { text-align: center; color: #5f6368; padding: 30px 20px; font-size: 15px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background-color: #ffffff; margin: auto; padding: 24px; border: none; border-radius: 12px; width: 100%; max-width: 390px; position: relative; max-height: calc(100vh - 40px); display: flex; flex-direction: column; box-shadow: 0 4px 24px rgba(0,0,0,0.15); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid #e8eaed; margin-bottom: 20px; }
        .modal-header h4 { font-size: 18px; color: #202124; font-weight: 500; }
        .modal-close-btn { color: #5f6368; font-size: 28px; font-weight: normal; cursor: pointer; line-height: 1; font-family: 'Material Icons';}
        .modal-close-btn:hover { color: #202124; }
        .modal-body { flex-grow: 1; overflow-y: auto; margin-bottom: 20px; padding-right: 5px; }
        .modal-body input[type="search"] { padding: 12px 14px; border: 1px solid #dadce0; border-radius: 8px; font-size: 15px; background-color: #f8f9fa; width: 100%; margin-bottom: 15px; }
        .modal-body input[type="search"]:focus { outline: none; border-color: #1a73e8; box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2); background-color: #fff; }
        .modal-list-item { padding: 12px 8px; border-bottom: 1px solid #f1f3f4; cursor: default; font-size: 15px; }
        .modal-list-item:hover { background-color: #f8f9fa; }
        .modal-list-item:last-child { border-bottom: none; }
        .modal-footer { text-align: right; padding-top:16px; border-top:1px solid #e8eaed;}
        .modal-footer .btn { width: auto; padding: 10px 20px; font-size: 14px; margin-left: 12px; }
        .address-item-details { cursor: pointer; padding: 4px 0; }
        .address-item-actions { margin-top: 8px; text-align: right; }
        .address-item-actions button { margin-left: 10px; }
        .default-tag { font-size: 10px; color: #fff; background-color: #34a853; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; font-weight: 500; }
        .pickup-time-modal-tabs { display: flex; border-bottom: 1px solid #dadce0; margin-bottom: 16px; }
        .pickup-time-modal-tab { flex: 1; padding: 12px 8px; text-align: center; cursor: pointer; font-weight: 500; color: #5f6368; border-bottom: 3px solid transparent; font-size: 14px; }
        .pickup-time-modal-tab.active { color: #1a73e8; border-bottom-color: #1a73e8; }
        .pickup-time-slots-for-day { display: none; }
        .pickup-time-slots-for-day.active { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .pickup-time-slot { padding: 10px; border: 1px solid #dadce0; border-radius: 8px; cursor: pointer; text-align: center; font-size: 14px; background-color: #fff; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .pickup-time-slot:hover { background-color: #f1f3f4; border-color: #8ab4f8; }
        .pickup-time-slot.selected { background-color: #e8f0fe; border-color: #1a73e8; color: #1a73e8; font-weight: 500; }
        .valuation-options label, .packaging-options label { display: flex; align-items: center; margin-bottom: 10px; font-size: 14px; color: #3c4043; }
        .valuation-options input[type="radio"], .packaging-options input[type="radio"] { margin-right: 10px; accent-color: #1a73e8; }
        .valuation-options input[type="number"] { margin-left: 10px; width: 100px; padding: 6px 8px; font-size: 14px; border-radius: 6px; }
        .record-detail-modal-body .detail-line { display: flex; padding: 10px 0; font-size: 15px; border-bottom: 1px solid #f1f3f4; }
        .record-detail-modal-body .detail-line:last-child { border-bottom: none; }
        .record-detail-modal-body .detail-label { color: #5f6368; flex-basis: 40%; font-weight: 500; }
        .record-detail-modal-body .detail-value { color: #202124; flex-basis: 60%; word-break: break-word; text-align: right;}
        #toast-modal { align-items: center; background-color: transparent; pointer-events: none; padding-bottom: 30px; }
        #toast-message { background-color: #323232; color: white; padding: 12px 20px; border-radius: 24px; margin-bottom: 70px; font-size: 14px; pointer-events: all; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="page-content">
            <!-- 寄件页面 (Page 1) -->
            <div id="page-send" class="page active">
                <div id="send-package-content">
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                           <h3>寄件人信息</h3>
                           <div class="address-book-btn-container">
                               <button class="btn-small" onclick="openAddressBookModal('sender')">地址薄</button>
                           </div>
                        </div>
                        <div class="form-group"><label for="sender-name">姓名</label><input type="text" id="sender-name"></div>
                        <div class="form-group"><label for="sender-phone">手机</label><input type="tel" id="sender-phone"></div>
                        <div class="form-group address-selection-group"><label>所在地区</label><div id="sender-region" class="clickable-field" onclick="openRegionPicker('sender')"><span class="placeholder">请选择省/市/区</span></div></div>
                        <div class="form-group"><label for="sender-detail-address">详细地址</label><textarea id="sender-detail-address" placeholder="街道、楼牌号等"></textarea></div>
                    </div>
                    <hr style="margin: 20px -18px; border: 0; border-top: 1px solid #e8eaed;">
                     <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <h3>收件人信息</h3>
                            <div class="address-book-btn-container">
                                <button class="btn-small" onclick="openAddressBookModal('receiver')">地址薄</button>
                            </div>
                        </div>
                        <div class="form-group"><label for="receiver-name">姓名</label><input type="text" id="receiver-name" value="李四"></div>
                        <div class="form-group"><label for="receiver-phone">手机</label><input type="tel" id="receiver-phone" value="13900139000"></div>
                         <div class="form-group address-selection-group"><label>所在地区</label><div id="receiver-region" class="clickable-field" onclick="openRegionPicker('receiver')"><span class="value">北京市 / 北京城区 / 朝阳区</span></div></div>
                        <div class="form-group"><label for="receiver-detail-address">详细地址</label><textarea id="receiver-detail-address" placeholder="街道、楼牌号等">建国路88号</textarea></div>
                    </div>
                    <div class="form-section">
                        <h3>寄件人企业信息</h3>
                        <div class="form-group"><label>所在区域</label><div id="company-location-region" class="clickable-field" onclick="openGenericSelectModal('locationRegion')"><span class="value">顺德本部</span></div></div>
                        <div class="form-group"><label>单位主体</label><div id="company-entity" class="clickable-field" onclick="openGenericSelectModal('company')"><span class="value">默认科技公司A</span></div></div>
                        <div class="form-group"><label>所属部门</label><div id="company-department" class="clickable-field" onclick="openGenericSelectModal('department')"><span class="value">研发部</span></div></div>
                    </div>
                    <div class="form-section">
                        <h3>上门取件预约</h3>
                        <div class="form-group"><label>期望上门时间</label><div id="pickup-time-display" class="clickable-field" onclick="openPickupTimeModal()"><span class="placeholder">请选择上门时间</span></div></div>
                        <div class="form-group"><label for="product-type">产品类型</label><select id="product-type"></select></div>
                        <div class="form-group"><label>物品信息</label><div id="item-info-display" class="clickable-field" onclick="openItemInfoModal()"><span class="placeholder">请选择物品信息、保价与包装</span></div></div>
                        <div class="form-group"><label>付款方式</label><div class="payment-method">寄付月结</div></div>
                    </div>
                    <div class="send-package-bottom-bar">
                        <div class="price-estimate">预估总价：<span id="estimated-price">¥0.00</span></div>
                        <div class="terms-agreement"><input type="checkbox" id="agree-terms"><label for="agree-terms">阅读并同意<a href="#" onclick="alert('显示条款详情')">《XX服务条款》</a></label></div>
                        <button id="submit-package-btn" class="btn" onclick="submitPackage()">立即下单</button>
                    </div>
                </div>
            </div>

            <!-- 到付登记页面 (New Page 2) -->
            <div id="page-cod-register" class="page">
                <div id="register-cod-content-wrapper">
                     <div class="form-section">
                        <h3>登记到付信息</h3>
                        <div class="form-group"><label for="cod-tracking-number">运单号码</label><input type="text" id="cod-tracking-number" placeholder="请输入运单号码"></div>
                        <div class="form-group"><label for="cod-amount">费用 (元)</label><input type="number" id="cod-amount" placeholder="请输入到付金额"></div>
                        <div class="form-group"><label for="cod-date">到付日期</label><input type="date" id="cod-date"></div>
                        <div class="form-group"><label for="cod-sender">寄件人</label><input type="text" id="cod-sender" placeholder="请输入寄件人姓名"></div>
                        <div class="form-group"><label for="cod-receiver">收件人</label><input type="text" id="cod-receiver" placeholder="请输入收件人姓名"></div>
                        <div class="form-group"><label>所在区域</label><div id="cod-location-region" class="clickable-field" onclick="openGenericSelectModal('codLocationRegion')"><span class="value">顺德本部</span></div></div>
                        <div class="form-group"><label>单位主体</label><div id="cod-company-entity" class="clickable-field" onclick="openGenericSelectModal('cod-company')"><span class="value">默认科技公司A</span></div></div>
                        <div class="form-group"><label>所属部门</label><div id="cod-company-department" class="clickable-field" onclick="openGenericSelectModal('cod-department')"><span class="value">研发部</span></div></div>
                        <button class="btn btn-submit" style="margin-top: 20px;" onclick="submitCodInfo()">提交登记</button>
                    </div>
                </div>
            </div>

            <!-- 订单记录页面 (New Page 3) -->
            <div id="page-order-records" class="page">
                <div class="order-records-header">
                     <input type="search" id="order-record-search-input" placeholder="搜索运单号/收寄人..." oninput="filterOrderRecords()">
                     <div class="filter-tags">
                        <span class="filter-tag active" data-filter-type="all" onclick="applyOrderRecordFilter('all', this)">全部</span>
                        <span class="filter-tag" data-filter-type="sent" onclick="applyOrderRecordFilter('sent', this)">寄件</span>
                        <span class="filter-tag" data-filter-type="cod" onclick="applyOrderRecordFilter('cod', this)">到付登记</span>
                     </div>
                </div>
                <div id="order-card-list-container" class="order-card-list">
                    <div class="no-records">暂无订单记录</div>
                </div>
            </div>
        </div> 
        <nav class="bottom-nav">
             <div class="nav-item active" data-page="page-send"><span class="nav-icon">local_shipping</span>寄件</div>
             <div class="nav-item" data-page="page-cod-register"><span class="nav-icon">post_add</span>到付登记</div>
             <div class="nav-item" data-page="page-order-records"><span class="nav-icon">history</span>订单记录</div>
        </nav>
    </div>

    <!-- Modals -->
    <div id="address-book-modal" class="modal"><div class="modal-content"><div class="modal-header"><h4>选择地址</h4><span class="modal-close-btn" onclick="closeModal('address-book-modal')">close</span></div><div class="modal-body"><input type="search" id="address-search" placeholder="搜索姓名/电话/地址" onkeyup="filterAddressBook()"><div id="address-list" style="margin-bottom:15px;"></div></div><div class="modal-footer" style="justify-content: space-between; display:flex;"><button class="btn btn-secondary" style="background-color: #dadce0; color: #202124;" onclick="openAddEditAddressModal()">新增地址</button></div></div></div>
    <div id="add-edit-address-modal" class="modal"><div class="modal-content"><div class="modal-header"><h4 id="add-edit-address-modal-title">新增地址</h4><span class="modal-close-btn" onclick="closeModal('add-edit-address-modal')">close</span></div><div class="modal-body"><input type="hidden" id="editing-address-id"><div class="form-group"><label>姓名:</label><input type="text" id="new-addr-name"></div><div class="form-group"><label>电话:</label><input type="tel" id="new-addr-phone"></div><div class="form-group address-selection-group"><label>所在地区:</label><div id="new-addr-region-display" class="clickable-field" onclick="openRegionPicker('new-addr')"><span class="placeholder">请选择省/市/区</span></div><input type="hidden" id="new-addr-provinceVal"> <input type="hidden" id="new-addr-cityVal"> <input type="hidden" id="new-addr-districtVal"></div><div class="form-group"><label>详细地址:</label><textarea id="new-addr-detail" placeholder="街道、楼牌号等"></textarea></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveOrUpdateAddress()">保存</button></div></div></div>
    <div id="region-picker-modal" class="modal"><div class="modal-content"><div class="modal-header"><h4>选择地区</h4><span class="modal-close-btn" onclick="closeModal('region-picker-modal')">close</span></div><div class="modal-body"><div class="form-group"><label for="region-province">省份</label><select id="region-province" onchange="populateCitiesForRegionPicker()"></select></div><div class="form-group"><label for="region-city">城市</label><select id="region-city" onchange="populateDistrictsForRegionPicker()"></select></div><div class="form-group"><label for="region-district">区/县</label><select id="region-district"></select></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="confirmRegionSelection()">确定</button></div></div></div>
    <div id="company-select-modal" class="modal"><div class="modal-content"><div class="modal-header"><h4 id="company-modal-title">选择</h4><span class="modal-close-btn" onclick="closeModal('company-select-modal')">close</span></div><div class="modal-body"><input type="search" id="company-search" placeholder="搜索..."><div id="company-list-content"></div></div></div></div>
    <div id="item-info-modal" class="modal"><div class="modal-content"><div class="modal-header"><h4>物品信息、保价与包装</h4><span class="modal-close-btn" onclick="closeModal('item-info-modal')">close</span></div><div class="modal-body"><div class="form-group"><label for="item-type">物品类型</label><select id="item-type"><option value="文件">文件</option><option value="数码产品">数码产品</option><option value="服饰">服饰</option><option value="日用品">日用品</option><option value="其他">其他</option></select></div><div class="form-group"><label for="item-weight">预估总重量 (kg)</label><input type="number" id="item-weight" value="1" min="0.1" step="0.1"></div><div class="form-group"><label for="item-count">件数</label><input type="number" id="item-count" value="1" min="1"></div><hr style="margin: 20px -24px; border:0; border-top:1px solid #e8eaed;"><h5>保价服务</h5><div class="form-group valuation-options"><label><input type="radio" name="valuation" value="none" checked onchange="toggleCustomValuation()">不保价</label><label><input type="radio" name="valuation" value="tier1" onchange="toggleCustomValuation()">保价金额1-500元 (服务费 ¥2)</label><label><input type="radio" name="valuation" value="tier2" onchange="toggleCustomValuation()">保价金额501-1000元 (服务费 ¥3)</label><label><input type="radio" name="valuation" value="custom" onchange="toggleCustomValuation()">自定义保价 <input type="number" id="custom-valuation-amount" placeholder="金额" style="display:none;" oninput="updateCustomValuationFee()"> <span id="custom-valuation-fee-display" style="font-size:12px; margin-left:5px;"></span></label></div><hr style="margin: 20px -24px; border:0; border-top:1px solid #e8eaed;"><h5>包装服务 (可选)</h5><div class="form-group packaging-options"><label for="packaging-service">选择包装</label><select id="packaging-service"></select></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="confirmItemInfo()">确定</button></div></div></div>
    <div id="pickup-time-modal" class="modal"><div class="modal-content"><div class="modal-header"><h4>选择上门时间</h4><span class="modal-close-btn" onclick="closeModal('pickup-time-modal')">close</span></div><div class="pickup-time-modal-tabs"><div class="pickup-time-modal-tab active" data-day="today">今天</div><div class="pickup-time-modal-tab" data-day="tomorrow">明天</div><div class="pickup-time-modal-tab" data-day="dayAfterTomorrow">后天</div></div><div class="modal-body" id="pickup-time-slots-container-wrapper"><div id="pickup-time-slots-today" class="pickup-time-slots-for-day active"></div><div id="pickup-time-slots-tomorrow" class="pickup-time-slots-for-day"></div><div id="pickup-time-slots-dayAfterTomorrow" class="pickup-time-slots-for-day"></div></div></div></div>
    <div id="order-detail-modal" class="modal"><div class="modal-content"><div class="modal-header"><h4 id="order-detail-modal-title">订单详情</h4><span class="modal-close-btn" onclick="closeModal('order-detail-modal')">close</span></div><div class="modal-body record-detail-modal-body" id="order-detail-content"></div><div class="modal-footer" id="order-detail-modal-footer"><button class="btn btn-secondary" style="background-color: #dadce0; color: #202124;" onclick="closeModal('order-detail-modal')">关闭</button></div></div></div>
    <div id="baitiao-payment-modal" class="modal"><div class="modal-content"><div class="modal-header"><h4>白条支付</h4><span class="modal-close-btn" onclick="closeModal('baitiao-payment-modal')">close</span></div><div class="modal-body"><input type="hidden" id="payment-order-id"><input type="hidden" id="payment-order-type"><div class="form-group"><label>待支付金额</label><div id="payment-amount-display" style="font-size: 20px; font-weight: bold; color: #d93025; margin-bottom:10px;">¥0.00</div></div><div class="form-group"><label>支付方式</label><div class="payment-method">白条支付</div></div><div class="form-group"><label for="payment-company">付款企业</label><select id="payment-company"><option value="comp_x">XYZ科技公司</option><option value="comp_y">ABC集团</option><option value="comp_z">123物流</option></select></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitBaiTiaoPayment()">确认支付</button></div></div></div>
    <div id="toast-modal" class="modal" style="align-items: center; background-color: transparent; pointer-events: none; padding-bottom: 30px;"><div id="toast-message" style="background-color: #323232; color: white; padding: 12px 20px; border-radius: 24px; margin-bottom: 70px; font-size: 14px; pointer-events: all; box-shadow: 0 2px 10px rgba(0,0,0,0.2);"></div></div>

    <script>
        // --- MOCK DATA ---
        const REGION_DATA = { "北京市": { "北京城区": ["东城区", "西城区", "朝阳区", "海淀区"], "北京郊区": ["昌平区", "顺义区"] }, "广东省": { "深圳市": ["福田区", "南山区"], "广州市": ["天河区", "越秀区"] }, "上海市": { "上海城区": ["黄浦区", "静安区"], "上海郊区": ["浦东新区"] }};
        let MOCK_ADDRESS_BOOK = [ { id: 1, name: "张三", phone: "13800138000", province: "广东省", city: "深圳市", district: "南山区", detailAddress: "科技园路1号", isDefault: true }, { id: 2, name: "李四", phone: "13900139000", province: "北京市", city: "北京城区", district: "朝阳区", detailAddress: "建国路88号", isDefault: false },];
        let nextAddressId = 3;
        const MOCK_LOCATIONS = [ { id: "sd", name: "顺德本部" }, { id: "bj", name: "北京" }, { id: "cd", name: "成都" }, { id: "jm", name: "江门" }, { id: "nn", name: "南宁" }, { id: "sz", name: "深圳" }, { id: "wh", name: "武汉" }, { id: "cs", name: "长沙" }, { id: "zz", name: "郑州" }, { id: "cq", name: "重庆" }, { id: "zh", name: "珠海" }, { id: "wuhu", name: "芜湖" }];
        const MOCK_COMPANIES = [ { id: "comp_a", name: "默认科技公司A" }, { id: "comp_b", name: "创新科技B" }];
        const MOCK_DEPARTMENTS = { "comp_a": [{ id: "dept_a1", name: "研发部" }, { id: "dept_a2", name: "市场部" }], "comp_b": [{ id: "dept_b1", name: "产品部" }]};
        const MOCK_PRODUCT_TYPES = [ "顺丰标快", "顺丰特快", "陆运包裹" ];
        const MOCK_PACKAGING_SERVICES = [ { id: "none", name: "不需要包装服务", cost: 0 }, { id: "F2", name: "防湿损F2", cost: 5 }];
        
        let sentOrders = []; 
        let codRegisteredOrders = []; 

        let currentAddressTarget = null, currentSelectedItemInfo = { type: '文件', weight: 1, count: 1, valuationType: 'none', valuationAmount: 0, valuationFee: 0, packagingServiceId: 'none', packagingFee: 0 };
        let editingAddressId = null, currentPickupTimeDay = 'today', currentRegionPickerTarget = null;
        let currentGenericSelectionTarget = null, currentGenericSelectionTargetElementId = null;
        let currentOrderRecordFilter = 'all';


        document.addEventListener('DOMContentLoaded', () => {
            initNavigation();
            initOrderRecordFilterTags(); 
            initPickupTimeModalTabs();
            populateProductTypes(); populatePackagingServices(); setDefaultSenderReceiver();
            setDefaultPickupTimeDisplay(); 
            document.getElementById('cod-date').value = new Date().toISOString().split('T')[0];
            
            const companyLocationRegionEl = document.getElementById('company-location-region')?.querySelector('.value');
            if (companyLocationRegionEl) companyLocationRegionEl.textContent = "顺德本部";
            const codLocationRegionEl = document.getElementById('cod-location-region')?.querySelector('.value');
            if (codLocationRegionEl) codLocationRegionEl.textContent = "顺德本部";
            
            renderOrderRecords(); 
        });

        function setDefaultSenderReceiver() {
            const defaultSender = MOCK_ADDRESS_BOOK.find(a => a.isDefault);
            const target = defaultSender || (MOCK_ADDRESS_BOOK.length > 0 ? MOCK_ADDRESS_BOOK[0] : null);
            if (target) {
                 document.getElementById('sender-name').value = target.name;
                 document.getElementById('sender-phone').value = target.phone;
                 updateRegionDisplay('sender', target.province, target.city, target.district);
                 document.getElementById('sender-detail-address').value = target.detailAddress;
            } else {
                 document.getElementById('sender-name').value = ''; document.getElementById('sender-phone').value = '';
                 updateRegionDisplay('sender', '', '', ''); 
                 document.getElementById('sender-detail-address').value = '';
            }
            const receiverRegionValEl = document.getElementById('receiver-region')?.querySelector('.value');
            if (receiverRegionValEl && !receiverRegionValEl.textContent.includes('/')) { 
                updateRegionDisplay('receiver', '北京市', '北京城区', '朝阳区');
            }
        }
        
        function openGenericSelectModal(selectionType) {
            currentGenericSelectionTarget = selectionType;
            const modalTitleEl = document.getElementById('company-modal-title');
            const searchInputEl = document.getElementById('company-search');
            searchInputEl.value = ''; searchInputEl.onkeyup = filterGenericList; 
            let itemsToRender = [];
            switch (selectionType) {
                case 'locationRegion':
                    modalTitleEl.textContent = '选择所在区域'; itemsToRender = MOCK_LOCATIONS;
                    currentGenericSelectionTargetElementId = 'company-location-region'; break;
                case 'codLocationRegion': 
                    modalTitleEl.textContent = '选择所在区域 (到付)'; itemsToRender = MOCK_LOCATIONS;
                    currentGenericSelectionTargetElementId = 'cod-location-region'; break;
                case 'company':
                    modalTitleEl.textContent = '选择单位主体'; itemsToRender = MOCK_COMPANIES;
                    currentGenericSelectionTargetElementId = 'company-entity'; break;
                case 'department':
                    modalTitleEl.textContent = '选择所属部门';
                    const compName = document.getElementById('company-entity').querySelector('.value').textContent;
                    const comp = MOCK_COMPANIES.find(c=>c.name===compName); itemsToRender = comp?(MOCK_DEPARTMENTS[comp.id]||[]):[];
                    currentGenericSelectionTargetElementId = 'company-department'; break;
                case 'cod-company':
                    modalTitleEl.textContent = '选择单位主体 (到付)'; itemsToRender = MOCK_COMPANIES;
                    currentGenericSelectionTargetElementId = 'cod-company-entity'; break;
                case 'cod-department':
                    modalTitleEl.textContent = '选择所属部门 (到付)';
                    const codCompN = document.getElementById('cod-company-entity').querySelector('.value').textContent;
                    const codC = MOCK_COMPANIES.find(c=>c.name===codCompN); itemsToRender = codC?(MOCK_DEPARTMENTS[codC.id]||[]):[];
                    currentGenericSelectionTargetElementId = 'cod-company-department'; break;
                default: console.error("Unknown type:", selectionType); return;
            }
            renderGenericList(itemsToRender); openModal('company-select-modal');
        }
        
        function filterGenericList() {
            const term = document.getElementById('company-search').value;
            let items = []; let companyNameForDept, companyForDept;
            switch (currentGenericSelectionTarget) {
                case 'locationRegion': case 'codLocationRegion': items = MOCK_LOCATIONS; break;
                case 'company': case 'cod-company': items = MOCK_COMPANIES; break;
                case 'department': companyNameForDept = document.getElementById('company-entity').querySelector('.value').textContent; companyForDept = MOCK_COMPANIES.find(c=>c.name===companyNameForDept); items = companyForDept?(MOCK_DEPARTMENTS[companyForDept.id]||[]):[]; break;
                case 'cod-department': companyNameForDept = document.getElementById('cod-company-entity').querySelector('.value').textContent; companyForDept = MOCK_COMPANIES.find(c=>c.name===companyNameForDept); items = companyForDept?(MOCK_DEPARTMENTS[companyForDept.id]||[]):[]; break;
                default: items = [];
            }
            renderGenericList(items, term);
        }

        function selectGenericItem(item) {
            if (currentGenericSelectionTargetElementId) {
                 const targetValueEl = document.getElementById(currentGenericSelectionTargetElementId).querySelector('.value');
                 targetValueEl.textContent = item.name;
                 if (currentGenericSelectionTarget === 'company' || currentGenericSelectionTarget === 'cod-company') {
                    const deptFieldId = currentGenericSelectionTarget === 'company' ? 'company-department' : 'cod-company-department';
                    const deptValueEl = document.getElementById(deptFieldId)?.querySelector('.value');
                    if (deptValueEl) {
                         const depts = MOCK_DEPARTMENTS[item.id] || [];
                         deptValueEl.textContent = depts.length > 0 ? depts[0].name : '无可选部门';
                    }
                 }
            }
            closeModal('company-select-modal'); showToast(`已选择: ${item.name}`);
        }
        renderGenericList = function(items, searchTerm = '') { const listEl = document.getElementById('company-list-content'); listEl.innerHTML = ''; const filtered = items.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase())); if (filtered.length === 0) { listEl.innerHTML = '<div class="modal-list-item" style="text-align:center; color:#5f6368;">无匹配结果</div>'; return; } filtered.forEach(item => { const div = document.createElement('div'); div.classList.add('modal-list-item'); div.textContent = item.name; div.onclick = () => selectGenericItem(item); listEl.appendChild(div); });}
        
        function isFieldValueValid(valueFromElementOrString) {
            let value = '';
            if (typeof valueFromElementOrString === 'string') { value = valueFromElementOrString.trim(); } 
            else if (valueFromElementOrString && typeof valueFromElementOrString.value !== 'undefined') { value = valueFromElementOrString.value.trim(); } 
            else if (valueFromElementOrString && valueFromElementOrString.dataset && typeof valueFromElementOrString.dataset.value !== 'undefined') { value = valueFromElementOrString.dataset.value.trim(); } 
            else if (valueFromElementOrString && valueFromElementOrString.querySelector) { 
                 const valueEl = valueFromElementOrString.querySelector('.value');
                 const placeholderEl = valueFromElementOrString.querySelector('.placeholder');
                 if (placeholderEl && getComputedStyle(placeholderEl).display !== 'none' && placeholderEl.textContent.includes("请选择")) return false;
                 value = valueEl ? valueEl.textContent.trim() : '';
            }
            return value !== '' && !value.includes("请选择") && value !== "无可选部门";
        }


        function submitPackage() { 
            const senderName = document.getElementById('sender-name').value.trim(); 
            const senderPhone = document.getElementById('sender-phone').value.trim();
            const senderRegionEl = document.getElementById('sender-region');
            const senderDetailAddress = document.getElementById('sender-detail-address').value.trim();
            
            const receiverName = document.getElementById('receiver-name').value.trim(); 
            const receiverPhone = document.getElementById('receiver-phone').value.trim();
            const receiverRegionEl = document.getElementById('receiver-region');
            const receiverDetailAddress = document.getElementById('receiver-detail-address').value.trim();
            
            const locationRegion = document.getElementById('company-location-region').querySelector('.value').textContent.trim();
            const companyEntity = document.getElementById('company-entity').querySelector('.value').textContent.trim();
            const companyDepartment = document.getElementById('company-department').querySelector('.value').textContent.trim();
            
            const pickupTimeDisplay = document.getElementById('pickup-time-display'); 
            const productType = document.getElementById('product-type').value; 
            const itemInfoDisplay = document.getElementById('item-info-display');
            const itemInfoText = itemInfoDisplay.querySelector('.value')?.textContent || itemInfoDisplay.querySelector('.placeholder')?.textContent;
            const agreeTerms = document.getElementById('agree-terms').checked; 
            
            let missingFields = [];
            if (!senderName) missingFields.push("寄件人姓名");
            if (!senderPhone) missingFields.push("寄件人手机");
            if (!isFieldValueValid(senderRegionEl)) missingFields.push("寄件人所在地区");
            if (!senderDetailAddress) missingFields.push("寄件人详细地址");

            if (!receiverName) missingFields.push("收件人姓名");
            if (!receiverPhone) missingFields.push("收件人手机");
            if (!isFieldValueValid(receiverRegionEl)) missingFields.push("收件人所在地区");
            if (!receiverDetailAddress) missingFields.push("收件人详细地址");

            if (!isFieldValueValid(locationRegion)) missingFields.push("寄件人所在区域");
            if (!isFieldValueValid(companyEntity)) missingFields.push("单位主体");
            if (!isFieldValueValid(companyDepartment)) missingFields.push("所属部门");

            if (!isFieldValueValid(pickupTimeDisplay)) missingFields.push("期望上门时间");
            if (!productType) missingFields.push("产品类型"); 
            if (!itemInfoText || itemInfoText.includes("请选择")) missingFields.push("物品信息");
            
            if (missingFields.length > 0) { showToast(`请填写或选择: ${missingFields.join(', ')}`); return; }
            if (!agreeTerms) { showToast("请阅读并同意服务条款！"); return; } 
            
            showToast("正在下单..."); 
            const estimatedPriceVal = document.getElementById('estimated-price').textContent;
            const submissionTime = new Date().toISOString();
            const packageData = { 
                type: 'sent', id: 'SF' + Date.now(), 
                senderDetails: { name: senderName, phone: senderPhone, province: senderRegionEl.dataset.province, city: senderRegionEl.dataset.city, district: senderRegionEl.dataset.district, detail: senderDetailAddress },
                receiverDetails: { name: receiverName, phone: receiverPhone, province: receiverRegionEl.dataset.province, city: receiverRegionEl.dataset.city, district: receiverRegionEl.dataset.district, detail: receiverDetailAddress },
                locationRegion: locationRegion, companyEntity: companyEntity, companyDepartment: companyDepartment,
                productType: productType, items: itemInfoText, 
                estimatedPrice: estimatedPriceVal, 
                actualPaidAmount: estimatedPriceVal, // Will be updated on payment if different
                pickupTime: pickupTimeDisplay.querySelector('.value').textContent, 
                submissionTimestamp: submissionTime, 
                orderUser: "李思思", // ADDED - Mocked user
                status: '待揽件', 
                paymentStatus: '待支付',
                pickupTimestamp: null, 
                paymentTimestamp: null 
            }; 
            setTimeout(() => { 
                showToast(`下单成功！运单号：${packageData.id}`); 
                sentOrders.unshift(packageData); renderOrderRecords(); 
                document.getElementById('item-info-display').innerHTML = `<span class="placeholder">请选择物品信息、保价与包装</span>`; 
                currentSelectedItemInfo = { type: '文件', weight: 1, count: 1, valuationType: 'none', valuationAmount: 0, valuationFee: 0, packagingServiceId: 'none', packagingFee: 0 }; 
                calculateAndUpdatePrice(); document.getElementById('agree-terms').checked = false; 
                setDefaultPickupTimeDisplay(); 
                const pickupTimeEl = document.getElementById('pickup-time-display'); if(pickupTimeEl) pickupTimeEl.dataset.value = '';
                document.getElementById('product-type').value = "顺丰标快"; 
            }, 1500); 
        }
        
        function submitCodInfo() { 
            const trackingNumber = document.getElementById('cod-tracking-number').value.trim(); 
            const amount = document.getElementById('cod-amount').value; 
            const date = document.getElementById('cod-date').value; 
            const sender = document.getElementById('cod-sender').value.trim(); 
            const receiver = document.getElementById('cod-receiver').value.trim(); 
            const locationRegionCod = document.getElementById('cod-location-region').querySelector('.value').textContent.trim();
            const company = document.getElementById('cod-company-entity').querySelector('.value').textContent.trim(); 
            const department = document.getElementById('cod-company-department').querySelector('.value').textContent.trim(); 
            
            let missingCodFields = [];
            if (!trackingNumber) missingCodFields.push("运单号码");
            if (!amount) missingCodFields.push("费用");
            if (!date) missingCodFields.push("到付日期");
            if (!sender) missingCodFields.push("寄件人");
            if (!receiver) missingCodFields.push("收件人");
            if (!isFieldValueValid(locationRegionCod)) missingCodFields.push("COD所在区域");
            if (!isFieldValueValid(company)) missingCodFields.push("COD单位主体");
            if (!isFieldValueValid(department)) missingCodFields.push("COD所属部门");

            if (missingCodFields.length > 0) { showToast(`请填写或选择: ${missingCodFields.join(', ')}`); return; }
            if (parseFloat(amount) <= 0) { showToast("金额必须大于0！"); return; } 
            if (!/^[a-zA-Z0-9]+$/.test(trackingNumber)) { showToast("运单号格式不正确。"); return; } 
            
            showToast("正在提交登记..."); 
            const registrationTime = new Date().toISOString();
            const codData = { 
                type: 'cod', id: trackingNumber.toUpperCase(), amount: `¥${parseFloat(amount).toFixed(2)}`, date: date, 
                sender: sender, receiver: receiver, locationRegion: locationRegionCod, company: company, 
                department: department, registrationTimestamp: registrationTime,
                registrationMethod: '人工登记', 
                registeredByUser: '李思思', // ADDED - Mocked user for manual registration
                paymentStatus: '已支付', 
                paymentTimestamp: registrationTime 
            }; 
            setTimeout(() => { 
                showToast(`到付信息登记成功: ${codData.id}`); 
                codRegisteredOrders.unshift(codData); renderOrderRecords(); 
                document.getElementById('cod-tracking-number').value = ''; document.getElementById('cod-amount').value = ''; 
                document.getElementById('cod-sender').value = ''; document.getElementById('cod-receiver').value = '';
                document.getElementById('cod-location-region').querySelector('.value').textContent = "顺德本部";
                document.getElementById('cod-company-entity').querySelector('.value').textContent = "默认科技公司A"; 
                document.getElementById('cod-company-department').querySelector('.value').textContent = "研发部";
            }, 1500); 
        }
        
        function initOrderRecordFilterTags() { const tags = document.querySelectorAll('.filter-tag'); tags.forEach(tag => { tag.addEventListener('click', function() { tags.forEach(t => t.classList.remove('active')); this.classList.add('active'); currentOrderRecordFilter = this.dataset.filterType; renderOrderRecords(); }); });}
        function filterOrderRecords() { renderOrderRecords(); }
        function applyOrderRecordFilter(filterType, clickedTagElement) { document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active')); if(clickedTagElement) clickedTagElement.classList.add('active'); currentOrderRecordFilter = filterType; renderOrderRecords(); }
        
        function renderOrderRecords() {
            const searchTerm = document.getElementById('order-record-search-input').value.toLowerCase();
            const listContainer = document.getElementById('order-card-list-container');
            listContainer.innerHTML = '';

            let allOrders = [...sentOrders, ...codRegisteredOrders].sort((a,b) => 
                new Date(b.submissionTimestamp || b.registrationTimestamp) - new Date(a.submissionTimestamp || a.registrationTimestamp)
            );

            let filteredOrders = allOrders;
            if (currentOrderRecordFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.type === currentOrderRecordFilter);
            }

            if (searchTerm) {
                filteredOrders = filteredOrders.filter(order => {
                    const senderName = order.type === 'sent' ? (order.senderDetails?.name || '') : (order.sender || '');
                    const receiverName = order.type === 'sent' ? (order.receiverDetails?.name || '') : (order.receiver || '');
                    return String(order.id).toLowerCase().includes(searchTerm) ||
                           senderName.toLowerCase().includes(searchTerm) ||
                           receiverName.toLowerCase().includes(searchTerm);
                });
            }

            if (filteredOrders.length === 0) {
                listContainer.innerHTML = `<div class="no-records">${searchTerm ? '无匹配搜索结果' : '暂无订单记录'}</div>`;
                return;
            }

            filteredOrders.forEach(order => {
                const card = document.createElement('div');
                card.classList.add('order-card');
                card.onclick = () => showOrderDetailModal(order.id, order.type);

                let statusText = '', statusClass = '', amountDisplayHtml = '', dateTime = new Date(order.submissionTimestamp || order.registrationTimestamp).toLocaleString('zh-CN', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
                let registrationMethodHtml = '';
                let pickupTimeHtml = ''; 

                if (order.type === 'sent') {
                    statusText = order.status;
                    statusClass = order.status === '已签收' ? 'status-delivered' : 
                                  order.status === '运输中' || order.status === '派送中' ? 'status-shipped' : 
                                  order.status === '待揽件' ? 'status-awaiting-pickup' : 
                                  'status-processing';
                    
                    amountDisplayHtml = `<div class="info-line"><span class="label">预估金额:</span><span class="value">${order.estimatedPrice}</span></div>`;
                    if (order.paymentStatus === '待支付') { 
                        statusText += ' (白条待付)'; statusClass = 'status-unpaid';
                        amountDisplayHtml += `<div class="info-line"><span class="label">实付金额:</span><span class="value">-</span></div>`;
                    } else if (order.paymentStatus === '已支付') { 
                        statusText += ' (白条已付)'; statusClass = 'status-paid'; 
                        amountDisplayHtml += `<div class="info-line"><span class="label">实付金额:</span><span class="value" style="color: #d93025; font-weight:500;">${order.actualPaidAmount}</span></div>`;
                    }
                    
                    if (order.status === '待揽件') {
                         pickupTimeHtml = `<div class="info-line"><span class="label">揽件时间:</span><span class="value">-</span></div>`;
                    } else if (order.pickupTimestamp) { 
                         pickupTimeHtml = `<div class="info-line"><span class="label">揽件时间:</span><span class="value">${new Date(order.pickupTimestamp).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'})}</span></div>`;
                    }


                } else { // cod
                    statusText = '已登记'; 
                    if (order.paymentStatus === '已支付') { 
                        statusText += ' (白条已付)';
                        statusClass = 'status-paid'; 
                    } else {
                        statusClass = 'status-registered';
                    }
                    amountDisplayHtml = `<div class="info-line"><span class="label">费用:</span><span class="value" style="color: #d93025; font-weight:500;">${order.amount}</span></div>`;
                    registrationMethodHtml = `<div class="info-line"><span class="label">登记方式:</span><span class="value">${order.registrationMethod || 'N/A'}</span></div>`;
                }
                
                card.innerHTML = `
                    <div class="order-card-header">
                        <span class="order-card-id">运单号: ${order.id}</span>
                        <span class="order-card-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="order-card-body">
                        <div class="info-line"><span class="label">寄件人:</span><span class="value">${order.type === 'sent' ? (order.senderDetails?.name || 'N/A') : (order.sender || 'N/A')}</span></div>
                        <div class="info-line"><span class="label">收件人:</span><span class="value">${order.type === 'sent' ? (order.receiverDetails?.name || 'N/A') : (order.receiver || 'N/A')}</span></div>
                        ${amountDisplayHtml}
                        ${order.type === 'sent' ? pickupTimeHtml : ''} 
                        ${registrationMethodHtml}
                    </div>
                    <div class="order-card-footer">${order.type === 'sent' ? '下单时间:' : '登记时间:'} ${dateTime}</div>`;
                listContainer.appendChild(card);
            });
        }
        
        function showOrderDetailModal(orderId, orderType) { 
            let order; 
            if (orderType === 'sent') { order = sentOrders.find(o => o.id === orderId); } 
            else { order = codRegisteredOrders.find(o => o.id === orderId); } 
            if (!order) { showToast("订单未找到！"); return; } 
            const detailContent = document.getElementById('order-detail-content'); 
            const modalTitle = document.getElementById('order-detail-modal-title'); 
            const modalFooter = document.getElementById('order-detail-modal-footer'); 
            detailContent.innerHTML = ''; 
            modalFooter.innerHTML = `<button class="btn btn-secondary" style="background-color: #dadce0; color: #202124;" onclick="closeModal('order-detail-modal')">关闭</button>`; 
            let detailsHtml = ''; 
            if (orderType === 'sent') { 
                modalTitle.textContent = '寄件订单详情'; 
                const senderAddr = `${order.senderDetails.province || ''} ${order.senderDetails.city || ''} ${order.senderDetails.district || ''} ${order.senderDetails.detail || ''}`.trim(); 
                const receiverAddr = `${order.receiverDetails.province || ''} ${order.receiverDetails.city || ''} ${order.receiverDetails.district || ''} ${order.receiverDetails.detail || ''}`.trim(); 
                const actualPaidDisplay = order.paymentStatus === '已支付' ? `<span class="detail-value" style="color:#d93025; font-weight:bold;">${order.actualPaidAmount}</span>` : '<span class="detail-value">-</span>';
                const paymentTimeDisplay = order.paymentStatus === '已支付' && order.paymentTimestamp ? new Date(order.paymentTimestamp).toLocaleString('zh-CN', { year:'numeric', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' }) : '-';
                const pickupTimeDisplayDetail = order.status === '待揽件' ? '-' : (order.pickupTimestamp ? new Date(order.pickupTimestamp).toLocaleString('zh-CN', { year:'numeric', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' }) : '-');

                detailsHtml = `
                    <div class="detail-line"><span class="detail-label">运单号:</span><span class="detail-value">${order.id}</span></div>
                    <div class="detail-line"><span class="detail-label">寄件人:</span><span class="detail-value">${order.senderDetails.name} (${order.senderDetails.phone})</span></div>
                    <div class="detail-line"><span class="detail-label">寄件地址:</span><span class="detail-value">${senderAddr}</span></div>
                    <div class="detail-line"><span class="detail-label">所在区域:</span><span class="detail-value">${order.locationRegion || '-'}</span></div>
                    <div class="detail-line"><span class="detail-label">单位主体:</span><span class="detail-value">${order.companyEntity || '-'}</span></div>
                    <div class="detail-line"><span class="detail-label">所属部门:</span><span class="detail-value">${order.companyDepartment || '-'}</span></div>
                    <hr style="margin: 8px 0; border-color: #e8eaed; border-style: dashed;">
                    <div class="detail-line"><span class="detail-label">收件人:</span><span class="detail-value">${order.receiverDetails.name} (${order.receiverDetails.phone})</span></div>
                    <div class="detail-line"><span class="detail-label">收件地址:</span><span class="detail-value">${receiverAddr}</span></div>
                    <hr style="margin: 8px 0; border-color: #e8eaed; border-style: dashed;">
                    <div class="detail-line"><span class="detail-label">产品类型:</span><span class="detail-value">${order.productType}</span></div>
                    <div class="detail-line"><span class="detail-label">物品信息:</span><span class="detail-value">${order.items}</span></div>
                    <div class="detail-line"><span class="detail-label">预估金额:</span><span class="detail-value">${order.estimatedPrice}</span></div>
                    <div class="detail-line"><span class="detail-label">实付金额:</span>${actualPaidDisplay}</div>
                    <div class="detail-line"><span class="detail-label">期望上门:</span><span class="detail-value">${order.pickupTime}</span></div>
                    <div class="detail-line"><span class="detail-label">下单时间:</span><span class="detail-value">${new Date(order.submissionTimestamp).toLocaleString('zh-CN')}</span></div>
                    <div class="detail-line"><span class="detail-label">下单用户:</span><span class="detail-value">${order.orderUser || '-'}</span></div>
                    <div class="detail-line"><span class="detail-label">运单状态:</span><span class="detail-value">${order.status}</span></div>
                    <div class="detail-line"><span class="detail-label">揽件时间:</span><span class="detail-value">${pickupTimeDisplayDetail}</span></div>
                    <div class="detail-line"><span class="detail-label">白条支付状态:</span><span class="detail-value" style="color:${order.paymentStatus === '待支付' ? '#f5222d' : '#34a853'}">${order.paymentStatus}</span></div>
                    <div class="detail-line"><span class="detail-label">支付时间:</span><span class="detail-value">${paymentTimeDisplay}</span></div>
                `; 
                if (order.paymentStatus === '待支付') { const payButton = document.createElement('button'); payButton.classList.add('btn', 'btn-primary'); payButton.textContent = '去支付'; payButton.style.marginLeft = '10px'; payButton.onclick = () => openBaiTiaoPaymentModal(order.id, order.type, order.estimatedPrice); modalFooter.appendChild(payButton); } 
            } else { // cod
                modalTitle.textContent = '到付登记详情'; 
                const paymentTimeDisplayCod = order.paymentTimestamp ? new Date(order.paymentTimestamp).toLocaleString('zh-CN', { year:'numeric', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' }) : '-';
                const registeredUserDisplay = order.registrationMethod === '人工登记' && order.registeredByUser ? order.registeredByUser : '-';
                detailsHtml = `
                    <div class="detail-line"><span class="detail-label">运单号码:</span><span class="detail-value">${order.id}</span></div>
                    <div class="detail-line"><span class="detail-label">费用:</span><span class="detail-value" style="color:#d93025; font-weight:bold;">${order.amount}</span></div>
                    <div class="detail-line"><span class="detail-label">到付日期:</span><span class="detail-value">${new Date(order.date).toLocaleDateString('zh-CN')}</span></div>
                    <div class="detail-line"><span class="detail-label">寄件人:</span><span class="detail-value">${order.sender}</span></div>
                    <div class="detail-line"><span class="detail-label">收件人:</span><span class="detail-value">${order.receiver}</span></div>
                    <div class="detail-line"><span class="detail-label">所在区域:</span><span class="detail-value">${order.locationRegion || '-'}</span></div>
                    <div class="detail-line"><span class="detail-label">单位主体:</span><span class="detail-value">${order.company}</span></div>
                    <div class="detail-line"><span class="detail-label">所属部门:</span><span class="detail-value">${order.department}</span></div>
                    <div class="detail-line"><span class="detail-label">登记方式:</span><span class="detail-value">${order.registrationMethod}</span></div>
                    <div class="detail-line"><span class="detail-label">登记用户:</span><span class="detail-value">${registeredUserDisplay}</span></div>
                    <div class="detail-line"><span class="detail-label">登记时间:</span><span class="detail-value">${new Date(order.registrationTimestamp).toLocaleString('zh-CN')}</span></div>
                    <div class="detail-line"><span class="detail-label">白条支付状态:</span><span class="detail-value" style="color:#34a853;">已支付</span></div>
                    <div class="detail-line"><span class="detail-label">支付时间:</span><span class="detail-value">${paymentTimeDisplayCod}</span></div>
                `; 
            } 
            detailContent.innerHTML = detailsHtml; openModal('order-detail-modal'); 
        }
        
        openBaiTiaoPaymentModal = function(orderId, orderType, amount) { document.getElementById('payment-order-id').value = orderId; document.getElementById('payment-order-type').value = orderType; document.getElementById('payment-amount-display').textContent = amount; document.getElementById('payment-company').selectedIndex = 0; closeModal('order-detail-modal'); openModal('baitiao-payment-modal'); }
        submitBaiTiaoPayment = function() { 
            const orderId = document.getElementById('payment-order-id').value; 
            const orderType = document.getElementById('payment-order-type').value; 
            const paymentCompany = document.getElementById('payment-company').value; 
            if (!paymentCompany) { showToast("请选择付款企业！"); return; } 
            showToast("正在处理支付..."); 
            setTimeout(() => { 
                let orderToUpdate; 
                if (orderType === 'sent') { 
                    orderToUpdate = sentOrders.find(o => o.id === orderId); 
                    if (orderToUpdate) { 
                        orderToUpdate.paymentStatus = '已支付'; 
                        orderToUpdate.actualPaidAmount = orderToUpdate.estimatedPrice; 
                        orderToUpdate.paymentTimestamp = new Date().toISOString(); 
                        if(orderToUpdate.status === '待揽件'){
                            orderToUpdate.status = '已揽收'; 
                            orderToUpdate.pickupTimestamp = new Date(new Date(orderToUpdate.submissionTimestamp).getTime() + Math.random() * (3 * 60 * 60 * 1000) + (60 * 60 * 1000)).toISOString(); 
                        }
                    } 
                } 
                closeModal('baitiao-payment-modal'); showToast("支付成功！"); 
                renderOrderRecords(); 
            }, 1500); 
        }
        // --- (All other JS functions from previous final version are assumed to be here) ---
        populateProductTypes = function() { const select = document.getElementById('product-type'); select.innerHTML = ''; MOCK_PRODUCT_TYPES.forEach(type => { const option = document.createElement('option'); option.value = type; option.textContent = type; if (type === "顺丰标快") option.selected = true; select.appendChild(option); }); }
        setDefaultPickupTimeDisplay = function() { document.getElementById('pickup-time-display').innerHTML = `<span class="placeholder">请选择上门时间</span>`; }
        populatePackagingServices = function() { const select = document.getElementById('packaging-service'); select.innerHTML = ''; MOCK_PACKAGING_SERVICES.forEach(service => { const option = document.createElement('option'); option.value = service.id; option.textContent = `${service.name} (+¥${service.cost})`; select.appendChild(option); }); }
        initNavigation = function() { const navItems = document.querySelectorAll('.bottom-nav .nav-item'); navItems.forEach(item => { item.addEventListener('click', () => { navItems.forEach(i => i.classList.remove('active')); document.querySelectorAll('.app-container .page').forEach(p => p.classList.remove('active')); item.classList.add('active'); const pageId = item.getAttribute('data-page'); document.getElementById(pageId).classList.add('active'); if(pageId === 'page-order-records') { document.getElementById('order-record-search-input').value = ''; currentOrderRecordFilter = 'all'; applyOrderRecordFilter('all', document.querySelector('.filter-tag[data-filter-type="all"]')); } }); }); }
        initOrderRecordFilterTags = function() { const tags = document.querySelectorAll('.filter-tag'); tags.forEach(tag => { tag.addEventListener('click', function() { tags.forEach(t => t.classList.remove('active')); this.classList.add('active'); currentOrderRecordFilter = this.dataset.filterType; renderOrderRecords(); }); });}
        openModal = function(modalId) { document.getElementById(modalId).classList.add('active'); }
        closeModal = function(modalId) { document.getElementById(modalId).classList.remove('active'); }
        showToast = function(message) { const toast = document.getElementById('toast-modal'); const msg = document.getElementById('toast-message'); msg.textContent = message; toast.classList.add('active'); setTimeout(() => toast.classList.remove('active'), 2500); }
        openRegionPicker = function(targetPrefix) { currentRegionPickerTarget = targetPrefix; const provinceSelect = document.getElementById('region-province'); provinceSelect.innerHTML = '<option value="">请选择省份</option>'; Object.keys(REGION_DATA).forEach(province => { const option = document.createElement('option'); option.value = province; option.textContent = province; provinceSelect.appendChild(option); }); document.getElementById('region-city').innerHTML = '<option value="">请选择城市</option>'; document.getElementById('region-district').innerHTML = '<option value="">请选择区/县</option>'; openModal('region-picker-modal'); }
        populateCitiesForRegionPicker = function() { const province = document.getElementById('region-province').value; const citySelect = document.getElementById('region-city'); citySelect.innerHTML = '<option value="">请选择城市</option>'; document.getElementById('region-district').innerHTML = '<option value="">请选择区/县</option>'; if (province && REGION_DATA[province]) { Object.keys(REGION_DATA[province]).forEach(city => { const option = document.createElement('option'); option.value = city; option.textContent = city; citySelect.appendChild(option); }); } }
        populateDistrictsForRegionPicker = function() { const province = document.getElementById('region-province').value; const city = document.getElementById('region-city').value; const districtSelect = document.getElementById('region-district'); districtSelect.innerHTML = '<option value="">请选择区/县</option>'; if (province && city && REGION_DATA[province] && REGION_DATA[province][city]) { REGION_DATA[province][city].forEach(district => { const option = document.createElement('option'); option.value = district; option.textContent = district; districtSelect.appendChild(option); }); } }
        confirmRegionSelection = function() { const province = document.getElementById('region-province').value; const city = document.getElementById('region-city').value; const district = document.getElementById('region-district').value; if (!province || !city || !district) { showToast("请选择完整的省市区信息。"); return; } updateRegionDisplay(currentRegionPickerTarget, province, city, district); closeModal('region-picker-modal'); }
        updateRegionDisplay = function(targetPrefix, province, city, district) { const displayElement = document.getElementById(`${targetPrefix}-region`); const displayElementModal = document.getElementById(`${targetPrefix}-region-display`); const displayText = (province && city && district) ? `${province} / ${city} / ${district}` : '<span class="placeholder">请选择省/市/区</span>'; if (displayElement) { if (province && city && district) { displayElement.innerHTML = `<span class="value">${displayText}</span>`; } else { displayElement.innerHTML = displayText; } displayElement.dataset.province = province; displayElement.dataset.city = city; displayElement.dataset.district = district; } if (displayElementModal) { if (province && city && district) { displayElementModal.innerHTML = `<span class="value">${displayText}</span>`; } else { displayElementModal.innerHTML = displayText; } document.getElementById('new-addr-provinceVal').value = province; document.getElementById('new-addr-cityVal').value = city; document.getElementById('new-addr-districtVal').value = district;} }
        openAddressBookModal = function(target) { currentAddressTarget = target; renderAddressBook(); document.getElementById('address-search').value = ''; openModal('address-book-modal');}
        renderAddressBook = function(searchTerm = '') {const listElement = document.getElementById('address-list'); listElement.innerHTML = ''; const filteredAddresses = MOCK_ADDRESS_BOOK.filter(addr => addr.name.toLowerCase().includes(searchTerm.toLowerCase()) || addr.phone.includes(searchTerm) || (addr.province + addr.city + addr.district + addr.detailAddress).toLowerCase().includes(searchTerm.toLowerCase())).sort((a,b) => b.isDefault - a.isDefault || a.name.localeCompare(b.name, 'zh-CN')); if (filteredAddresses.length === 0) { listElement.innerHTML = '<div class="modal-list-item" style="text-align:center; color:#5f6368; padding: 20px 0;">无匹配结果或地址薄为空</div>'; return; } filteredAddresses.forEach(addr => {const item = document.createElement('div'); item.classList.add('modal-list-item'); let defaultTag = addr.isDefault ? '<span class="default-tag">默认</span>' : ''; const fullAddr = `${addr.province || ''} ${addr.city || ''} ${addr.district || ''} ${addr.detailAddress || ''}`; item.innerHTML = `<div class="address-item-details" onclick="selectAddress(${addr.id})"><strong>${addr.name}</strong>${defaultTag} <span style="color:#5f6368; font-size:14px;">(${addr.phone})</span><br><small style="color:#5f6368; display:block; margin-top:2px;">${fullAddr.trim()}</small></div><div class="address-item-actions">${!addr.isDefault ? `<button class="btn-link" onclick="setAsDefaultAddress(${addr.id})">设为默认</button>` : ''}<button class="btn-link" onclick="openAddEditAddressModal(${addr.id})">修改</button><button class="btn-link" style="color:#d93025;" onclick="deleteAddress(${addr.id})">删除</button></div>`; listElement.appendChild(item); });}
        filterAddressBook = function() { renderAddressBook(document.getElementById('address-search').value); }
        selectAddress = function(addressId) { const addr = MOCK_ADDRESS_BOOK.find(a => a.id === addressId); if (!addr) return; const targetPrefix = currentAddressTarget; document.getElementById(`${targetPrefix}-name`).value = addr.name; document.getElementById(`${targetPrefix}-phone`).value = addr.phone; updateRegionDisplay(targetPrefix, addr.province, addr.city, addr.district); document.getElementById(`${targetPrefix}-detail-address`).value = addr.detailAddress; closeModal('address-book-modal'); showToast(`已选择地址: ${addr.name}`);}
        openAddEditAddressModal = function(addressIdToEdit = null) { editingAddressId = addressIdToEdit; const modalTitle = document.getElementById('add-edit-address-modal-title'); const nameInput = document.getElementById('new-addr-name'); const phoneInput = document.getElementById('new-addr-phone'); const detailAddressInput = document.getElementById('new-addr-detail'); document.getElementById('editing-address-id').value = addressIdToEdit || ''; if (addressIdToEdit) { const addr = MOCK_ADDRESS_BOOK.find(a => a.id === addressIdToEdit); if (addr) { modalTitle.textContent = '修改地址'; nameInput.value = addr.name; phoneInput.value = addr.phone; updateRegionDisplay('new-addr', addr.province, addr.city, addr.district); detailAddressInput.value = addr.detailAddress; } } else { modalTitle.textContent = '新增地址'; nameInput.value = ''; phoneInput.value = ''; updateRegionDisplay('new-addr', '', '', ''); detailAddressInput.value = ''; } openModal('add-edit-address-modal');}
        saveOrUpdateAddress = function() { const id = document.getElementById('editing-address-id').value ? parseInt(document.getElementById('editing-address-id').value) : null; const name = document.getElementById('new-addr-name').value.trim(); const phone = document.getElementById('new-addr-phone').value.trim(); const province = document.getElementById('new-addr-provinceVal').value; const city = document.getElementById('new-addr-cityVal').value; const district = document.getElementById('new-addr-districtVal').value; const detailAddress = document.getElementById('new-addr-detail').value.trim(); if (!name || !phone || !province || !city || !district || !detailAddress) { showToast("请填写所有必填的地址信息。"); return; } if (!/^\d{11}$/.test(phone) && !/^\d{3,4}-\d{7,8}$/.test(phone) && !/^\d{7,8}$/.test(phone)) { showToast("请输入有效的手机或固话号码。"); return; } const addressData = { name, phone, province, city, district, detailAddress }; if (id) { const addrIndex = MOCK_ADDRESS_BOOK.findIndex(a => a.id === id); if (addrIndex > -1) { MOCK_ADDRESS_BOOK[addrIndex] = { ...MOCK_ADDRESS_BOOK[addrIndex], ...addressData }; showToast("地址已更新！"); } } else { const newAddr = { id: nextAddressId++, ...addressData, isDefault: MOCK_ADDRESS_BOOK.length === 0 }; MOCK_ADDRESS_BOOK.push(newAddr); showToast("新地址已保存！"); } renderAddressBook(); closeModal('add-edit-address-modal'); editingAddressId = null; document.getElementById('editing-address-id').value = ''; setDefaultSenderReceiver(); }
        setAsDefaultAddress = function(addressId) { MOCK_ADDRESS_BOOK.forEach(addr => addr.isDefault = (addr.id === addressId)); renderAddressBook(); showToast("默认地址已更新。"); setDefaultSenderReceiver(); }
        deleteAddress = function(addressId) { if (confirm("确定要删除此地址吗？")) { const addrIndex = MOCK_ADDRESS_BOOK.findIndex(a => a.id === addressId); if (addrIndex > -1) { const deletedAddr = MOCK_ADDRESS_BOOK.splice(addrIndex, 1)[0]; if (deletedAddr.isDefault && MOCK_ADDRESS_BOOK.length > 0) { MOCK_ADDRESS_BOOK[0].isDefault = true; } else if (MOCK_ADDRESS_BOOK.length === 0) { setDefaultSenderReceiver(); } renderAddressBook(); showToast("地址已删除。"); setDefaultSenderReceiver(); } } }
        initPickupTimeModalTabs = function() { const tabs = document.querySelectorAll('.pickup-time-modal-tab'); tabs.forEach(tab => { tab.addEventListener('click', () => { tabs.forEach(t => t.classList.remove('active')); tab.classList.add('active'); currentPickupTimeDay = tab.dataset.day; document.querySelectorAll('.pickup-time-slots-for-day').forEach(c => c.classList.remove('active')); document.getElementById(`pickup-time-slots-${currentPickupTimeDay}`).classList.add('active'); renderPickupTimeSlots(currentPickupTimeDay); }); }); }
        openPickupTimeModal = function() { currentPickupTimeDay = 'today'; document.querySelectorAll('.pickup-time-modal-tab').forEach(tab => { tab.classList.toggle('active', tab.dataset.day === 'today'); }); document.querySelectorAll('.pickup-time-slots-for-day').forEach(container => { container.classList.toggle('active', container.id === 'pickup-time-slots-today'); container.innerHTML = ''; }); renderPickupTimeSlots('today'); openModal('pickup-time-modal'); }
        renderPickupTimeSlots = function(dayKey) { const containerId = `pickup-time-slots-${dayKey}`; const container = document.getElementById(containerId); if (!container) return; container.innerHTML = ''; const baseDate = new Date(); if (dayKey === 'tomorrow') baseDate.setDate(baseDate.getDate() + 1); else if (dayKey === 'dayAfterTomorrow') baseDate.setDate(baseDate.getDate() + 2); let startHour = 8; if (dayKey === 'today') { startHour = Math.max(8, new Date().getHours() + 1); } for (let h = startHour; h <= 21; h++) { if (dayKey === 'today' && h <= new Date().getHours() && h < 8) continue; const slotStartStr = `${String(h).padStart(2, '0')}:00`; const slotEndStr = `${String(h + 1).padStart(2, '0')}:00`; const dateLabel = dayKey === 'today' ? '今天' : (dayKey === 'tomorrow' ? '明天' : '后天'); const slotDateTimeValue = `${baseDate.getFullYear()}-${String(baseDate.getMonth() + 1).padStart(2, '0')}-${String(baseDate.getDate()).padStart(2, '0')} ${slotStartStr}-${slotEndStr}`; const slotDisplay = `${slotStartStr} - ${slotEndStr}`; const slotDiv = document.createElement('div'); slotDiv.classList.add('pickup-time-slot'); slotDiv.textContent = slotDisplay; slotDiv.onclick = () => selectPickupTime(slotDateTimeValue, `${dateLabel} ${slotDisplay}`); container.appendChild(slotDiv); } if (container.innerHTML === '') { container.innerHTML = '<div class="no-records" style="padding:20px 0; grid-column: 1 / -1;">今日已无可预约时间</div>'; } }
        selectPickupTime = function(dateTimeValue, displayValue) { const displayElement = document.getElementById('pickup-time-display'); displayElement.innerHTML = `<span class="value">${displayValue}</span>`; displayElement.dataset.value = dateTimeValue; closeModal('pickup-time-modal'); showToast(`已选择上门时间: ${displayValue}`); }
        openItemInfoModal = function() { document.getElementById('item-type').value = currentSelectedItemInfo.type; document.getElementById('item-weight').value = currentSelectedItemInfo.weight; document.getElementById('item-count').value = currentSelectedItemInfo.count; document.querySelectorAll('input[name="valuation"]').forEach(radio => { radio.checked = (radio.value === currentSelectedItemInfo.valuationType); }); document.getElementById('custom-valuation-amount').value = currentSelectedItemInfo.valuationAmount > 0 ? currentSelectedItemInfo.valuationAmount : ''; toggleCustomValuation(); document.getElementById('packaging-service').value = currentSelectedItemInfo.packagingServiceId; openModal('item-info-modal');}
        toggleCustomValuation = function() { const customAmountInput = document.getElementById('custom-valuation-amount'); const customFeeDisplay = document.getElementById('custom-valuation-fee-display'); if (document.querySelector('input[name="valuation"][value="custom"]').checked) { customAmountInput.style.display = 'inline-block'; updateCustomValuationFee(); } else { customAmountInput.style.display = 'none'; customFeeDisplay.textContent = ''; }}
        updateCustomValuationFee = function() { const amount = parseFloat(document.getElementById('custom-valuation-amount').value); const feeDisplay = document.getElementById('custom-valuation-fee-display'); if (amount > 0) { let fee = Math.max(1, Math.min(20, amount * 0.01)); feeDisplay.textContent = `(服务费 ¥${fee.toFixed(2)})`; } else { feeDisplay.textContent = ''; }}
        confirmItemInfo = function() { currentSelectedItemInfo.type = document.getElementById('item-type').value; currentSelectedItemInfo.weight = parseFloat(document.getElementById('item-weight').value) || 1; currentSelectedItemInfo.count = parseInt(document.getElementById('item-count').value) || 1; const selectedValuationRadio = document.querySelector('input[name="valuation"]:checked'); currentSelectedItemInfo.valuationType = selectedValuationRadio.value; currentSelectedItemInfo.valuationAmount = 0; currentSelectedItemInfo.valuationFee = 0; if (currentSelectedItemInfo.valuationType === 'tier1') { currentSelectedItemInfo.valuationFee = 2; } else if (currentSelectedItemInfo.valuationType === 'tier2') { currentSelectedItemInfo.valuationFee = 3; } else if (currentSelectedItemInfo.valuationType === 'custom') { currentSelectedItemInfo.valuationAmount = parseFloat(document.getElementById('custom-valuation-amount').value) || 0; if (currentSelectedItemInfo.valuationAmount > 0) { currentSelectedItemInfo.valuationFee = Math.max(1, Math.min(20, currentSelectedItemInfo.valuationAmount * 0.01)); } else { currentSelectedItemInfo.valuationType = 'none';}} currentSelectedItemInfo.packagingServiceId = document.getElementById('packaging-service').value; const selectedPackaging = MOCK_PACKAGING_SERVICES.find(s => s.id === currentSelectedItemInfo.packagingServiceId); currentSelectedItemInfo.packagingFee = selectedPackaging ? selectedPackaging.cost : 0; let displayString = `${currentSelectedItemInfo.type}，${currentSelectedItemInfo.weight}kg，${currentSelectedItemInfo.count}件`; if (currentSelectedItemInfo.valuationType !== 'none') { let valText = ''; if (currentSelectedItemInfo.valuationType === 'tier1') valText = '保价(≤500)'; else if (currentSelectedItemInfo.valuationType === 'tier2') valText = '保价(≤1000)'; else if (currentSelectedItemInfo.valuationType === 'custom' && currentSelectedItemInfo.valuationAmount > 0) valText = `保价(¥${currentSelectedItemInfo.valuationAmount})`; if (valText) displayString += `，${valText}`; } if (selectedPackaging && selectedPackaging.id !== 'none') { displayString += `，${selectedPackaging.name.split(' ')[0]}`; } const displayElement = document.getElementById('item-info-display'); displayElement.innerHTML = `<span class="value">${displayString}</span>`; calculateAndUpdatePrice(); closeModal('item-info-modal'); showToast("物品信息已更新");}
        calculateAndUpdatePrice = function() { const basePrice = 12; const weightCharge = Math.max(0, (currentSelectedItemInfo.weight - 1) * 2); let totalItemsCost = (basePrice + weightCharge) * currentSelectedItemInfo.count; let estimatedPrice = totalItemsCost + currentSelectedItemInfo.valuationFee + currentSelectedItemInfo.packagingFee; document.getElementById('estimated-price').textContent = `¥${estimatedPrice.toFixed(2)}`;}
    </script>
</body>
</html>
